generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProfileType {
  INDIVIDUAL
  OOO
  IP
}

enum ProductState {
  NEW
  USED
}

model User {
  id                    Int         @id @default(autoincrement())
  fullName              String
  email                 String      @unique
  phoneNumber           String      @unique
  password              String
  rating                Int?
  profileType           ProfileType @default(INDIVIDUAL)
  refreshToken          String?
  refreshTokenExpiresAt DateTime?

  isResetVerified Boolean @default(false)

  products  Product[]
  favorites Product[] @relation("UserFavorites")

  // Чаты где пользователь покупатель
  chatsAsBuyer  Chat[]    @relation("BuyerChats")
  // Чаты где пользователь продавец  
  chatsAsSeller Chat[]    @relation("SellerChats")
  // Отправленные сообщения
  sentMessages  Message[] @relation("SentMessages")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          Int          @id @default(autoincrement())
  name        String
  price       Int
  state       ProductState
  brand       String?
  model       String?
  description String?
  address     String?
  images      String[]     @default([])
  categoryId  Int
  category    Category     @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  subCategoryId Int
  subCategory   SubCategory @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  favoritedBy User[] @relation("UserFavorites")
  // Чаты по этому товару
  chats       Chat[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Основная категория
model Category {
  id   Int    @id @default(autoincrement())
  name String

  products Product[]

  subCategories SubCategory[]
}

// Подкатегории
model SubCategory {
  id   Int    @id @default(autoincrement())
  name String

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  products Product[]
}

// Чат между покупателем и продавцом по конкретному товару
model Chat {
  id Int @id @default(autoincrement())

  // Товар, по которому ведётся чат
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Покупатель (инициатор чата)
  buyerId Int
  buyer   User @relation("BuyerChats", fields: [buyerId], references: [id], onDelete: Cascade)

  // Продавец (владелец товара)
  sellerId Int
  seller   User @relation("SellerChats", fields: [sellerId], references: [id], onDelete: Cascade)

  // Сообщения в чате
  messages Message[]

  // Количество непрочитанных сообщений для каждого участника
  unreadCountBuyer  Int @default(0)
  unreadCountSeller Int @default(0)

  // Последнее сообщение для быстрого доступа
  lastMessageId Int?
  lastMessage   Message? @relation("LastMessage", fields: [lastMessageId], references: [id])
  lastMessageAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Уникальный чат для каждой пары покупатель-продавец-товар
  @@unique([buyerId, sellerId, productId])
}

// Сообщения в чате
model Message {
  id Int @id @default(autoincrement())

  // Текст сообщения
  content String

  // Отправитель
  senderId Int
  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  // Чат, к которому относится сообщение
  chatId Int
  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  // Статус прочтения
  isRead Boolean   @default(false)
  readAt DateTime?

  // Связь для последнего сообщения
  lastMessageChats Chat[] @relation("LastMessage")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
