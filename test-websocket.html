<!doctype html>
<html>
  <head>
    <title>WebSocket Chat Test</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  </head>
  <body>
    <h1>WebSocket Chat Test</h1>
    <div>
      <h3>Step 1: Login first</h3>
      <input
        type="email"
        id="email"
        placeholder="Email"
        value="test@example.com"
      />
      <input
        type="password"
        id="password"
        placeholder="Password"
        value="password"
      />
      <button onclick="login()">Login</button>
      <div id="loginStatus"></div>
    </div>
    <div>
      <h3>Step 2: Test WebSocket</h3>
      <div id="status">Not connected</div>
      <button onclick="connectWS()">Connect WebSocket</button>
      <button onclick="joinChat()">Join Chat 1</button>
      <button onclick="sendMessage()">Send Test Message</button>
      <div id="messages"></div>
    </div>

    <script>
      let socket = null;

      // Функция для логина
      async function login() {
        const login = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
          const response = await fetch('http://localhost:3000/auth/sign-in', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include', // Важно для куков
            body: JSON.stringify({ login, password }),
          });

          if (response.ok) {
            const data = await response.json();
            document.getElementById('loginStatus').innerHTML =
              'Login successful! You can now connect WebSocket.';
            console.log('Login successful:', data);
          } else {
            const error = await response.json();
            document.getElementById('loginStatus').innerHTML =
              'Login failed: ' + (error.message || 'Unknown error');
          }
        } catch (error) {
          console.error('Login error:', error);
          document.getElementById('loginStatus').innerHTML =
            'Login error: ' + error.message;
        }
      }

      // Функция для подключения WebSocket
      function connectWS() {
        if (socket) {
          socket.disconnect();
        }

        // Подключение к WebSocket серверу с namespace
        socket = io('http://localhost:3000/chat', {
          transports: ['websocket'],
          upgrade: false,
          withCredentials: true, // Важно для передачи куков
        });

        socket.on('connect', () => {
          document.getElementById('status').innerHTML =
            'Connected! Socket ID: ' + socket.id;
          console.log('Connected to WebSocket server');
        });

        socket.on('disconnect', () => {
          document.getElementById('status').innerHTML = 'Disconnected';
          console.log('Disconnected from WebSocket server');
        });

        socket.on('error', (error) => {
          console.error('Socket error:', error);
          document.getElementById('status').innerHTML = 'Error: ' + error;
        });

        // Слушаем входящие сообщения
        socket.on('newMessage', (data) => {
          console.log('Received new message:', data);
          addMessage('New message: ' + JSON.stringify(data));
        });
      }

      // Функция для присоединения к чату
      function joinChat() {
        if (!socket) {
          addMessage('Please connect WebSocket first');
          return;
        }

        console.log('Sending joinChat event');
        socket.emit('joinChat', { chatId: 1 }, (response) => {
          console.log('Response from joinChat:', response);
          addMessage('joinChat response: ' + JSON.stringify(response));
        });
      }

      // Функция для отправки сообщения
      function sendMessage() {
        if (!socket) {
          addMessage('Please connect WebSocket first');
          return;
        }

        console.log('Sending sendMessage event');
        socket.emit(
          'sendMessage',
          {
            chatId: 1,
            content: 'Hello from test client!',
          },
          (response) => {
            console.log('Response from sendMessage:', response);
            addMessage('sendMessage response: ' + JSON.stringify(response));
          },
        );
      }

      function addMessage(text) {
        const messages = document.getElementById('messages');
        messages.innerHTML +=
          '<div>' + new Date().toLocaleTimeString() + ': ' + text + '</div>';
      }
    </script>
  </body>
</html>
